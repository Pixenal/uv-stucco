cmake_minimum_required(VERSION 3.2)
cmake_policy(SET CMP0063 NEW)
project(RUVM)
if (UNIX)
	message("Building for Unix")
	if(CMAKE_BUILD_TYPE MATCHES DEBUG)
		message("Debug build -- using gcc")
		set(CMAKE_C_COMPILER gcc)
		set(CMAKE_C_FLAGS "-g -O0 -DEBUG -pthread -Wshadow -Wunused -Wunused-parameter -D PLATFORM_LINUX -fPIC")
	endif(CMAKE_BUILD_TYPE MATCHES DEBUG)
	if(CMAKE_BUILD_TYPE MATCHES RELEASE)
		message("Release build -- using clang")
		set(CMAKE_C_COMPILER clang)
		set(CMAKE_C_FLAGS_RELEASE "-ftree-vectorize -mavx2 -finline-functions -flto -O2 -pthread -D PLATFORM_LINUX -fPIC")
	endif(CMAKE_BUILD_TYPE MATCHES RELEASE)
	set(RUVM_PLATFORM Src/PlatformLinux.c Src/ThreadPool.c)
	find_package(ZLIB REQUIRED)
endif()
if (WIN32)
	message("Building for Windows")
	set(CMAKE_C_FLAGS "/D PLATFORM_WINDOWS")
	set(CMAKE_C_STANDARD 11)
	set(RUVM_PLATFORM Src/PlatformWindows.c Src/ThreadPoolWindows.c)
	set(ZLIB_LIBRARIES ${ZLIB_LIB_PATH})
	set(ZLIB_DEPENDENCIES )
	set(ZLIB_INCLUDE_DIRS ${ZLIB_INCLUDE_PATH})
endif()
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
add_library(RUVM STATIC Src/Alloc.c Src/MergeBoundsFaces.c Src/Io.c Src/MapToFace.c Src/QuadTree.c Src/RUVM.c Src/EnclosingCells.c Src/MathUtils.c Src/Utils.c Src/AttribUtils.c Src/SingleBoundsFace.c Src/CombineJobMeshes.c Src/MapToJobMesh.c Src/ImageUtils.c ${RUVM_PLATFORM})
#set_property(TARGET RUVM PROPERTY C_VISIBILITY_PRESET hidden)
#set_property(TARGET RUVM PROPERTY C_VISIBILITY_INLINES_HIDDEN ON)
target_include_directories(RUVM PUBLIC Include)
target_include_directories(RUVM PRIVATE Src)
target_include_directories(RUVM PRIVATE ${ZLIB_INCLUDE_DIRS})
target_link_libraries(RUVM PRIVATE ${ZLIB_LIBRARIES} ${ZLIB_DEPENDENCIES})
