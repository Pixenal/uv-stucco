cmake_minimum_required(VERSION 3.2)
cmake_policy(SET CMP0063 NEW)
cmake_policy(SET CMP0091 NEW)
project(RUVM)
get_property(IS_MULTI_CONFIG GLOBAL PROPERTY GENERATOR_IS_MULTI_CONFIG)
if (NOT IS_MULTI_CONFIG)
	message("Building for single build type")
	if (NOT CMAKE_BUILD_TYPE)
		message("No build type specified, building Release")
		set(CMAKE_BUILD_TYPE Release "" FORCE)
	endif()
endif ()
if (UNIX)
	message("Building for Unix")
	if(CMAKE_BUILD_TYPE MATCHES DEBUG)
		message("Debug build")
		set(CMAKE_C_FLAGS "-g -O0 -DEBUG -pthread -Wshadow -Wunused -Wunused-parameter -D PLATFORM_LINUX -fPIC")
	endif(CMAKE_BUILD_TYPE MATCHES DEBUG)
	if(CMAKE_BUILD_TYPE MATCHES RELEASE)
		message("Release build")
		set(CMAKE_C_FLAGS_RELEASE "-ftree-vectorize -mavx2 -finline-functions -flto -O2 -pthread -D PLATFORM_LINUX -fPIC")
	endif(CMAKE_BUILD_TYPE MATCHES RELEASE)
	set(PLATFORM_SRC_FILES Src/Unix/FileUnix.c Src/Unix/ThreadPoolUnix.c)
endif()
if (WIN32)
	message("Building for Windows")
	message("CMAKE_MSVC_RUNTIME_LIB is " + ${CMAKE_MSVC_RUNTIME_LIBRARY})
	set(CMAKE_C_FLAGS "/D PLATFORM_WINDOWS /D WIN32 /D WINDOWS /TC")
	set(CMAKE_C_FLAGS_RELEASE "/O2")
	set(CMAKE_C_STANDARD 11)
	set(PLATFORM_SRC_FILES Src/Win/FileWin.c Src/Win/ThreadPoolWin.c)
	set(ZLIB_INCLUDE_DIRS Extern/zlib/Win/x64/include)
endif()
message("BUILD_SHARED_LIBS is " ${BUILD_SHARED_LIBS})
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
add_library(RUVM Src/Alloc.c Src/MergeBoundsFaces.c Src/Io.c Src/MapToFace.c
            Src/QuadTree.c Src/RUVM.c Src/MathUtils.c Src/Utils.c Src/AttribUtils.c
            Src/SingleBoundsFace.c Src/CombineJobMeshes.c Src/MapToJobMesh.c
            Src/ImageUtils.c Src/Mesh.c ${PLATFORM_SRC_FILES})
target_include_directories(RUVM PUBLIC Include)
target_include_directories(RUVM PRIVATE Src)
find_package(ZLIB REQUIRED CONFIG)
target_include_directories(RUVM PRIVATE ${ZLIB_INCLUDE_DIRS})
target_link_libraries(RUVM ZLIB::ZLIB)
